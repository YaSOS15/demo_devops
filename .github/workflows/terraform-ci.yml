name: Terraform fmt / validate / plan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform fmt / validate / plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform fmt (check) for known dirs
        run: |
          set -euo pipefail
          # liste explicite des dossiers possibles (ajoute d'autres chemins si besoin)
          CANDIDATES="./terraform ./infra ./terraform-*"
          FOUND=0
          for d in $CANDIDATES; do
            # shell globbing -> transforme en rien si aucun match
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                FOUND=1
                echo "Checking terraform fmt in $real"
                terraform -chdir="$real" fmt -check -recursive
              else
                echo "Skip $real (not a directory)"
              fi
            done
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "No terraform directories found among candidates: $CANDIDATES"
            exit 0
          fi

      - name: Terraform init (per-folder known)
        run: |
          set -euo pipefail
          CANDIDATES="./terraform ./infra ./terraform-*"
          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                echo "Init in $real"
                terraform -chdir="$real" init -input=false
              else
                echo "Skip init $real (not a directory)"
              fi
            done
          done

      - name: Terraform validate (per-folder known)
        run: |
          set -euo pipefail
          CANDIDATES="./terraform ./infra ./terraform-*"
          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                echo "Validate in $real"
                terraform -chdir="$real" validate
              else
                echo "Skip validate $real (not a directory)"
              fi
            done
          done

      - name: Terraform plan (create plan files)
        run: |
          set -euo pipefail
          mkdir -p .tfplans
          CANDIDATES="./terraform ./infra ./terraform-*"
          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                NAME=$(echo "$real" | tr '/' '_' | sed 's/^\._//')
                PLAN_NAME=".tfplans/${NAME}.tfplan"
                echo "Plan in $real -> $PLAN_NAME"
                terraform -chdir="$real" plan -input=false -out="$PLAN_NAME"
                terraform -chdir="$real" show -no-color "$PLAN_NAME" > "${PLAN_NAME}.txt" || true
              else
                echo "Skip plan $real (not a directory)"
              fi
            done
          done

      - name: Upload terraform plans (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plans
          path: .tfplans/
