name: Terraform fmt / validate / plan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform fmt / validate / plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      # ---------------------------
      # Terraform FMT
      # ---------------------------
      - name: Terraform fmt (check) for known dirs
        run: |
          set -euo pipefail
          CANDIDATES="./terraform ./infra ./terraform-*"
          FOUND=0
          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                FOUND=1
                echo "Checking terraform fmt in $real"
                terraform -chdir="$real" fmt -check -recursive
              else
                echo "Skip $real (not a directory)"
              fi
            done
          done

          if [ "$FOUND" -eq 0 ]; then
            echo "No terraform directories found. Candidate paths: $CANDIDATES"
            exit 0
          fi

      # ---------------------------
      # Terraform INIT
      # ---------------------------
      - name: Terraform init (per-folder)
        run: |
          set -euo pipefail
          CANDIDATES="./terraform ./infra ./terraform-*"

          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                echo "Init in $real"
                terraform -chdir="$real" init -input=false
              else
                echo "Skip init $real (not a directory)"
              fi
            done
          done

      # ---------------------------
      # Terraform VALIDATE
      # ---------------------------
      - name: Terraform validate (per-folder)
        run: |
          set -euo pipefail
          CANDIDATES="./terraform ./infra ./terraform-*"

          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue
              if [ -d "$real" ]; then
                echo "Validate in $real"
                terraform -chdir="$real" validate
              else
                echo "Skip validate $real (not a directory)"
              fi
            done
          done

      # ---------------------------
      # Terraform PLAN (robuste)
      # ---------------------------
      - name: Terraform plan (create plan files) - robust
        run: |
          set -euo pipefail
          mkdir -p .tfplans
          CANDIDATES="./terraform ./infra ./terraform-*"

          for d in $CANDIDATES; do
            for real in $d; do
              [ -z "$real" ] && continue

              if [ -d "$real" ]; then
                echo "==> Planning in $real"

                # VÃ©rifier/init
                terraform -chdir="$real" init -input=false || {
                  echo "ERROR: terraform init failed in $real"
                  ls -la "$real"
                  exit 1
                }

                NAME=$(echo "$real" | tr '/' '_' | sed 's/^\._//')
                TMP_PLAN="/tmp/${NAME}.tfplan"
                LOCAL_PLAN=".tfplans/${NAME}.tfplan"

                echo "Plan -> $TMP_PLAN"

                if terraform -chdir="$real" plan -input=false -out="$TMP_PLAN"; then
                  # Version lisible
                  terraform -chdir="$real" show -no-color "$TMP_PLAN" > "${LOCAL_PLAN}.txt" || true
                  cp "$TMP_PLAN" "$LOCAL_PLAN" || true

                  echo "Plan written to:"
                  echo "  - $LOCAL_PLAN"
                  echo "  - ${LOCAL_PLAN}.txt"

                else
                  echo "ERROR: terraform plan failed in $real"
                  ls -la "$real"
                  ls -la "$real/.terraform" || true
                  exit 1
                fi

              else
                echo "Skip plan $real (not a directory)"
              fi
            done
          done

      # ---------------------------
      # Upload des plans Terraform
      # ---------------------------
      - name: Upload Terraform plans
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plans
          path: .tfplans/
